<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<PropertyGroup>
		<GenerateInterfaces_ros2csDependsOn>
			$(GenerateInterfaces_ros2csDependsOn);GetRos2csProps
		</GenerateInterfaces_ros2csDependsOn>
	</PropertyGroup>

	<Target Name="GenerateInterfaces_ros2cs" BeforeTargets="DispatchToInnerBuilds;BeforeCompile;CoreCompile" 
			DependsOnTargets="$(GenerateInterfaces_ros2csDependsOn)"
			Inputs="$(Ros2csSpecFile)" Outputs="$(BaseIntermediateOutputPath)$(Ros2csOutputDir)\ros2cs.spec.cache">

		<Message Text="Ros2csSpec: $(Ros2csSpecFile)"/>

		<Message Text="Ros2csCmd: $(Ros2csCommand)"/>

		<Exec Command="$(Ros2csCommand)" WorkingDirectory="$(MSBuildProjectDirectory)"
			  ConsoleToMSBuild="true" IgnoreExitCode="true" Condition="'$(Ros2csSpecFile)' != ''">
			
			<Output TaskParameter="ConsoleOutput" ItemName="Ros2csOutput"/>
			<Output TaskParameter="ExitCode" PropertyName="Ros2csExitCode"/>
		</Exec>
		
		<Error Condition="'$(Ros2csSpecFile)' != '' and '$(Ros2csExitCode)' != '0'"
			   Text="'$(Ros2csCommand)' failed with exit code $(Ros2csExitCode):&#x0A;@(Ros2csOutput->'%(Identity)', '&#x0A;')" />

		<Copy SourceFiles="$(Ros2csSpecFile)" 
			  DestinationFiles="$(BaseIntermediateOutputPath)$(Ros2csOutputDir)\ros2cs.spec.cache" 
			  SkipUnchangedFiles="true" 
			  Condition="'$(Ros2csSpecFile)' != ''"/>
		
		<ItemGroup>
			<Compile Remove="@(Ros2csGenFiles)" />
			<Compile Include="$(BaseIntermediateOutputPath)$(Ros2csOutputDir)\**\*.g.cs"/>
		</ItemGroup>
	</Target>


	<PropertyGroup>
		<CleanGenerated_ros2csDependsOn>
			$(CleanGenerated_ros2csDependsOn);GetRos2csProps
		</CleanGenerated_ros2csDependsOn>
	</PropertyGroup>

	<Target Name="CleanGenerated_ros2cs" BeforeTargets="CoreClean" DependsOnTargets="$(CleanGenerated_ros2csDependsOn)"
			Condition="'$(TargetFrameworks)' == '' OR '$(TargetFramework)' == $(TargetFrameworks.Split(';')[0])">
		<RemoveDir Directories="$(BaseIntermediateOutputPath)$(Ros2csOutputDir)" ContinueOnError="true" />
	</Target>


	<Target Name="GetRos2csProps" DependsOnTargets="$(GetRos2csPropsDependsOn)">
		<PropertyGroup>
			<DefaultRos2csSpecFile>$(MSBuildProjectDirectory)\ros2cs.spec</DefaultRos2csSpecFile>
			<Ros2csSpecFile Condition="$(Ros2csSpecFile) == '' and Exists('$(DefaultRos2csSpecFile)')">$(DefaultRos2csSpecFile)</Ros2csSpecFile>

			<Ros2csCommand>dotnet $(Ros2csExe.Trim()) $(Ros2csArgs.Trim()) -o &quot;$(BaseIntermediateOutputPath)$(Ros2csOutputDir.Trim())&quot; &quot;$(Ros2csSpecFile.Trim())&quot;</Ros2csCommand>
		</PropertyGroup>
	</Target>


	<Target Name="CheckAmentPrefixPath" AfterTargets="GetRos2csProps" Condition="'$(Ros2csSpecFile)' != ''">
		<ReadLinesFromFile File="$(Ros2csSpecFile)">
			<Output TaskParameter="Lines" ItemName="Ros2csSpecFileLines"/>
		</ReadLinesFromFile>

		<Warning Code="RCL0002" File="$(Ros2csSpecFile)"
				 Condition="'$(AMENT_PREFIX_PATH)' == '' AND @(Ros2csSpecFileLines->AnyHaveMetadataValue('Identity', 'from-ament-index'))"
				 Text="'from-ament-index' option is specified in ros2cs.spec file but 'AMENT_PREFIX_PATH' Property or Environment Variable is not set/empty. ROS 2 interface packages may not be found." />
	</Target>

</Project>